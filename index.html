<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isnpro Market Profile</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="star-container"></div>
    <div id="sidebar-overlay"></div>

    <nav id="sidebar">
        <div class="sidebar-header-profile">
            <img src="https://api.deline.web.id/uhxRrZLShb.jpg" alt="Profile" class="sidebar-profile-pic-large">
            <h4 class="sidebar-market-name">ISNPRO MARKET</h4>
            <button id="btn-sidebar-info" class="btn-sidebar-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                Info
            </button>
        </div>

        <div class="sidebar-label">KATEGORI PRODUK</div>
        <ul class="sidebar-menu-list">
            <li>
                <a href="#" data-page="sewa_bot"> 
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Sewa bot</span>
                    </div>
                    <span id="count-sewa_bot" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="script_bot"> 
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Script bot</span>
                    </div>
                    <span id="count-script_bot" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="topup_game">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Diamond Free Fire</span>
                    </div>
                    <span id="count-topup_game" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="topup_game1">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Diamond Mobile Legend</span>
                    </div>
                    <span id="count-topup_game1" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="gamepass">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Robux Roblox</span>
                    </div>
                    <span id="count-gamepass" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="gamepass">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Gamepass Roblox</span>
                    </div>
                    <span id="count-gamepass" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="acc_allgame">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Akun Allgame</span>
                    </div>
                    <span id="count-acc_allgame" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="joki_allgame">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Joki Allgame</span>
                    </div>
                    <span id="count-joki_allgame" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
                <a href="#" data-page="apk_premium">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Apk Premium</span>
                    </div>
                    <span id="count-apk_premium" class="category-count">[ 0 ]</span>
                </a>
            </li>
            <li>
            <a href="#" data-page="campuran">
                    <div style="display:flex; align-items:center;">
                        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Icon" class="store-profile-pic">
                        <span>Produk Campuran</span>
                    </div>
                    <span id="count-campuran" class="category-count">[ 0 ]</span>
                </a>
            </li>
        </ul>

        <ul class="sidebar-footer-menu">
            <li>
                <a href="#" id="btn-home-l1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Kembali halaman utama</span>
                </a>
            </li>
            <li>
                <a href="#" id="btn-exit-l1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Keluar dari website</span>
                </a>
            </li>
        </ul>

        <div class="sidebar-copyright">
            © 2025 Isnpro Market. All rights reserved.
        </div>
    </nav>
    
    <div class="navbar" id="navbar">
        <div class="hamburger-menu">
            <div class="line"></div><div class="line"></div><div class="line"></div>
        </div>
        <div class="nav-title" id="navTitle" style="cursor: pointer;">WEBSITE MARKETPLACE</div>
        <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Profil" class="nav-profile-pic" id="navbarProfilePic">
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content-container">
            <div class="loading-spinner"></div>
            <img src="https://api.deline.web.id/ltSnd8k2WI.jpg" alt="Loading" class="loading-profile-pic">
        </div>
        <div id="loadingText" class="loading-text">loading</div>
    </div>

    <div id="halamanBaru" class="halaman-baru">
        
        <div id="default-content">
            <h2 style="font-size: 2rem; margin-bottom:10px; color: #00f2ff; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">Welcome to Website Isnpro</h2>
            <img src="https://api.deline.web.id/7JLp3oMozM.jpg" alt="Banner" class="welcome-image">
            <p style="margin-top: 15px;">Klik <b>garis tiga</b> (menu) untuk melihat kategori produk.</p>

            <div class="info-section">
                <h3 class="content-subheading">Kenapa beli di sini?</h3>
                <p class="info-text">1. Amanah & Terpercaya<br>2. Fast Respons<br>3. Harga Termurah</p>
            </div>
            <div class="info-section">
                <h3 class="content-subheading">Cara Memesan</h3>
                <p class="info-text">1. Buka Menu (Kiri Atas)<br>2. Pilih Kategori & Produk<br>3. Checkout Sekarang</p>
            </div>
        </div>

        <div id="sewa_bot-content" class="page-content"><h2 class="page-title">Halaman Sewa Bot</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari paket..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="topup_game-content" class="page-content"><h2 class="page-title">Halaman Diamond Free Fire</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari diamond..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="topup_game1-content" class="page-content"><h2 class="page-title">Halaman Diamond Mobile Legend</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari diamond..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="topup_game2-content" class="page-content"><h2 class="page-title">Halaman Robux Roblox [vilog]</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari robux..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="gamepass-content" class="page-content"><h2 class="page-title">Halaman Gamepass Roblox</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari gamepass..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="script_bot-content" class="page-content"><h2 class="page-title">Halaman Script Bot</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari script..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="acc_allgame-content" class="page-content"><h2 class="page-title">Jual Akun Allgame</h2><div class="search-wrapper"><input type="text" class="search-input" placeholder="Cari akun..."></div><hr class="page-divider"><div class="product-grid-placeholder"></div></div>
        <div id="joki_allgame-content" class="page-content">
            <h2 class="page-title">Jasa Joki Allgame</h2>
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Cari joki...">
            </div>
            <hr class="page-divider">
            <div class="product-grid-placeholder"></div>
        </div> 
        <div id="apk_premium-content" class="page-content">
            <h2 class="page-title">Aplikasi Premium</h2>
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Cari aplikasi...">
            </div>
            <hr class="page-divider">
            <div class="product-grid-placeholder"></div>
        </div>
        <div id="campuran-content" class="page-content">
            <h2 class="page-title">Produk Campuran</h2>
            <div class="search-wrapper">
                <input type="text" class="search-input" placeholder="Cari produk...">
            </div>
            <hr class="page-divider">
            <div class="product-grid-placeholder"></div>
        </div>

        <footer class="global-footer">
            © 2025 Isnpro Market. All rights reserved.
        </footer>
    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            
            <div class="slider-container">
                <button class="slider-btn prev-btn" onclick="moveSlide(-1)">&#10094;</button>
                <div id="modalImagesWrapper"></div>
                <button class="slider-btn next-btn" onclick="moveSlide(1)">&#10095;</button>
            </div>
            
            <div id="modalDetails">
                <h3 class="modal-title" id="mTitle">Nama Produk</h3>
                <div class="modal-price" id="mPrice">Rp 0</div>
                <div class="modal-desc" id="mDesc">Deskripsi...</div>
                
                <div class="modal-actions" id="modalActions">
                    </div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content modal-white-theme">
            <span class="close-modal text-dark" onclick="closeInfoModal()">&times;</span>
            
            <div class="info-header">
                <img src="https://api.deline.web.id/uhxRrZLShb.jpg" alt="Isnpro" class="info-modal-img">
                <h3 class="modal-title title-dark">ISNPRO MARKET</h3>
                <p class="info-subtitle">Trusted Marketplace & Store</p>
            </div>
            
            <p class="info-desc-text">
                Website resmi Isnpro. Solusi aman dan terpercaya untuk kebutuhan game dan topup Anda dengan harga pelajar.
            </p>

            <div class="info-btn-wrapper">
                <a href="https://wa.me/628988685425" target="_blank" class="btn-info-link whatsapp">
                    <div class="btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <span>Chat Admin Utama</span>
                </a>
                
                <a href="https://whatsapp.com/channel/0029Vaxm2K6A2pL5H5lr231U" target="_blank" class="btn-info-link testi">
                    <div class="btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    </div>
                    <span>Cek Testimoni Real</span>
                </a>

                <a href="https://chat.whatsapp.com/JyCFZuKyryIDUVs5Hv2D7T?mode=wwt" target="_blank" class="btn-info-link group">
                    <div class="btn-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                    <span>Join Group JB Isnpro</span>
                </a>
            </div>

            <div class="info-copyright">
                © 2025 Isnpro Market. All rights reserved.
            </div>
        </div>
    </div>

    <div id="fullscreenImageOverlay" class="fullscreen-overlay">
        <span class="close-fullscreen">&times;</span>
        
        <button class="fullscreen-btn prev" onclick="moveFullscreenSlide(-1)">&#10094;</button>
        <img src="" alt="Fullscreen Image" id="fullscreenImgDisplay">
        <button class="fullscreen-btn next" onclick="moveFullscreenSlide(1)">&#10095;</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBq7KGW5JMF6CwsIfx49vfL2K--B8RO-pQ",
            authDomain: "website-jb-24a86.firebaseapp.com",
            projectId: "website-jb-24a86",
            storageBucket: "website-jb-24a86.firebasestorage.app",
            messagingSenderId: "548884046832",
            appId: "1:548884046832:web:a2a3507c3f6935659ff335"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARIABEL UI ---
        const navbar = document.getElementById('navbar');
        const navTitle = document.getElementById('navTitle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const hamburger = document.querySelector('.hamburger-menu');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const halamanBaru = document.getElementById('halamanBaru');
        const defaultContent = document.getElementById('default-content');
        const allPageContent = document.querySelectorAll('.page-content');
        const productModal = document.getElementById('productModal');
        const modalImagesWrapper = document.getElementById('modalImagesWrapper'); 
        const prevBtn = document.querySelector('.slider-btn.prev-btn');
        const nextBtn = document.querySelector('.slider-btn.next-btn');
        const modalActions = document.getElementById('modalActions');

        // --- VARIABEL UNTUK FULLSCREEN ZOOM ---
        const fullscreenOverlay = document.getElementById('fullscreenImageOverlay');
        const fullscreenImgDisplay = document.getElementById('fullscreenImgDisplay');
        const closeFullscreenBtn = document.querySelector('.close-fullscreen');
        const fsPrevBtn = document.querySelector('.fullscreen-btn.prev');
        const fsNextBtn = document.querySelector('.fullscreen-btn.next');

        let loadingTimeout;
        let textInterval;
        let currentSlideIndex = 0;
        let currentModalImages = [];
        let currentFullscreenIndex = 0; 
        
        // --- DATA PENCARIAN & KATEGORI ---
        let currentProductsData = []; 
        let activeCategoryId = ''; 
        
        const categoryMap = {
            'sewa_bot': 'Halaman Sewa Bot', 
            'topup_game': 'Halaman Diamond Free Fire', 
            'topup_game1': 'Halaman Diamond Mobile Legend', 
            'topup_game2': 'Halaman Robux Roblox [vilog]', 
            'gamepass': 'Halaman Gamepass Roblox', 
            'script_bot': 'Halaman Script Bot',
            'acc_allgame': 'Halaman Jual Akun', 
            'joki_allgame': 'Halaman Joki Akun',
            'apk_premium': 'Aplikasi Premium',
            'campuran': 'Halaman Produk Campuran'
        };

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        // --- NAVIGATION LOGIC ---
        hamburger.addEventListener('click', () => {
            requestAnimationFrame(() => {
                sidebar.classList.add('show');
                sidebarOverlay.style.display = 'block';
                setTimeout(() => { sidebarOverlay.style.opacity = '1'; }, 10);
            });
        });

        window.closeAllSidebars = function() {
            sidebar.classList.remove('show');
            sidebarOverlay.style.opacity = '0';
            setTimeout(() => {
                if(!sidebar.classList.contains('show')) {
                    sidebarOverlay.style.display = 'none';
                }
            }, 300);
        }

        sidebarOverlay.addEventListener('click', closeAllSidebars);

        document.querySelectorAll('.sidebar-menu-list a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // Ignore jika klik di div atau span dalam link, pastikan target yang diproses benar
                let target = e.currentTarget;
                document.querySelectorAll('.sidebar-menu-list a').forEach(l => l.classList.remove('active'));
                target.classList.add('active');

                const pageId = target.dataset.page;
                setTimeout(() => {
                    closeAllSidebars();
                    if(pageId) showPage(pageId);
                }, 150);
            });
        });

        document.getElementById('btn-home-l1').addEventListener('click', (e) => {
            e.preventDefault(); closeAllSidebars(); startLoading(); 
        });
        document.getElementById('btn-exit-l1').addEventListener('click', (e) => {
            e.preventDefault(); if(confirm("Keluar dari website?")) history.back();
        });
        document.getElementById('navbarProfilePic').addEventListener('click', () => alert("Website Market By Isnpro"));
        navTitle.addEventListener('click', startLoading);

        // --- FUNGSI UPDATE HITUNGAN SIDEBAR ---
        async function updateSidebarCounts() {
            try {
                // Ambil SEMUA produk
                const q = query(collection(db, "products"));
                const snapshot = await getDocs(q);

                const counts = {
                    'sewa_bot': 0, 'script_bot': 0, 'topup_game': 0,
                    'topup_game1': 0, 'acc_allgame': 0, 'joki_allgame': 0,
                    'apk_premium': 0, 'campuran': 0
                };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (counts[data.category] !== undefined) {
                        counts[data.category]++;
                    }
                });

                for (const [key, value] of Object.entries(counts)) {
                    const badge = document.getElementById(`count-${key}`);
                    if(badge) badge.innerText = `[ ${value} ]`;
                }

            } catch (e) {
                console.error("Gagal menghitung kategori:", e);
            }
        }

        // --- FETCH PRODUCTS & SEARCH ---
        async function loadProducts(categoryId) {
            activeCategoryId = categoryId; 
            currentProductsData = []; 
            
            const container = document.querySelector(`#${categoryId}-content .product-grid-placeholder`);
            const searchInput = document.querySelector(`#${categoryId}-content .search-input`);

            if (!container) return;
            container.innerHTML = '<div class="empty-slot" style="color:#aaa;text-align:center; grid-column: 1/-1;">Memuat produk...</div>';

            // Reset Input Search
            if(searchInput) {
                searchInput.value = '';
                const newSearchInput = searchInput.cloneNode(true);
                searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                newSearchInput.addEventListener('input', (e) => handleSearch(e.target.value));
            }

            try {
                const q = query(collection(db, "products"), where("category", "==", categoryId), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="empty-slot" style="color:#aaa;text-align:center; grid-column: 1/-1;">Belum ada produk.</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    currentProductsData.push({ id: doc.id, ...doc.data() });
                });

                renderProducts(currentProductsData, container);

            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="empty-slot" style="color:red;text-align:center; grid-column: 1/-1;">Gagal memuat data.</div>';
            }
        }

        function handleSearch(keyword) {
            const container = document.querySelector(`#${activeCategoryId}-content .product-grid-placeholder`);
            if(!container) return;
            
            const lowerKeyword = keyword.toLowerCase();
            const filteredProducts = currentProductsData.filter(item => {
                const nameMatch = item.name.toLowerCase().includes(lowerKeyword);
                const descMatch = item.description.toLowerCase().includes(lowerKeyword);
                return nameMatch || descMatch;
            });

            if (filteredProducts.length > 0) {
                renderProducts(filteredProducts, container);
            } else {
                container.innerHTML = '<div class="empty-slot" style="color:#aaa;text-align:center; grid-column: 1/-1;">Produk tidak ditemukan.</div>';
            }
        }

        function renderProducts(productList, container) {
            container.innerHTML = ''; 

            productList.forEach((data) => {
                const priceFormatted = formatRupiah(data.price);
                const isOff = data.status === 'off';
                const badgeClass = isOff ? 'status-off' : 'status-stock';
                const badgeText = isOff ? 'OFF STOCK' : 'STOCK';
                const cardClassAdd = isOff ? 'is-off' : '';
                const btnClass = isOff ? 'btn-info btn-habis' : 'btn-info';
                const btnText = isOff ? 'HABIS' : 'BELI';
                const btnDisabled = isOff ? 'disabled' : '';

                const card = document.createElement('div');
                card.className = `product-card ${cardClassAdd}`;
                
                card.innerHTML = `
                    <div class="status-badge ${badgeClass}">${badgeText}</div>
                    <img src="${data.images[0]}" alt="${data.name}" class="card-img">
                    <div class="card-title">${data.name}</div>
                    <div class="card-price">${priceFormatted}</div>
                    <div class="card-desc-short">${data.description.substring(0, 50)}...</div>
                    <button class="${btnClass}" ${btnDisabled}>${btnText}</button>
                `;

                if(!isOff) {
                    card.querySelector('.btn-info').addEventListener('click', () => openModal(data));
                    card.querySelector('.card-img').addEventListener('click', () => openModal(data));
                }
                container.appendChild(card);
            });
        }

        // --- FULLSCREEN LOGIC ---
        window.openFullscreen = function(index) {
            currentFullscreenIndex = index;
            updateFullscreenImage();
            fullscreenOverlay.style.display = 'flex';
            
            const hasMultiple = currentModalImages.length > 1;
            fsPrevBtn.style.display = hasMultiple ? 'flex' : 'none';
            fsNextBtn.style.display = hasMultiple ? 'flex' : 'none';
        }

        function updateFullscreenImage() {
                if (currentModalImages.length > 0) {
                    fullscreenImgDisplay.src = currentModalImages[currentFullscreenIndex];
                }
        }

        window.moveFullscreenSlide = function(n) {
                if (currentModalImages.length <= 1) return;
                currentFullscreenIndex += n;
                if (currentFullscreenIndex >= currentModalImages.length) currentFullscreenIndex = 0;
                if (currentFullscreenIndex < 0) currentFullscreenIndex = currentModalImages.length - 1;
                updateFullscreenImage();
        }

        function closeFullscreen() {
            fullscreenOverlay.style.display = 'none';
            setTimeout(() => { fullscreenImgDisplay.src = ''; }, 300); 
        }

        closeFullscreenBtn.addEventListener('click', closeFullscreen);
        fullscreenOverlay.addEventListener('click', (e) => {
            if (e.target === fullscreenOverlay) {
                closeFullscreen();
            }
        });

        // --- MODAL PRODUCT LOGIC ---
        window.openModal = function(data) {
            currentModalImages = data.images;
            currentSlideIndex = 0;
            
            document.getElementById('mTitle').innerText = data.name;
            const priceFormatted = formatRupiah(data.price);
            document.getElementById('mPrice').innerText = priceFormatted;
            document.getElementById('mDesc').innerText = data.description;
            
            let rawWa = data.whatsapp.toString().replace(/\D/g, '');
            if (rawWa.startsWith('0')) rawWa = '62' + rawWa.substring(1);
            
            modalImagesWrapper.innerHTML = '';
            data.images.forEach((imgUrl, index) => {
                const img = document.createElement('img');
                img.src = imgUrl; 
                img.className = `slider-img ${index === 0 ? 'active' : ''}`;
                img.onclick = function() { openFullscreen(index); };
                modalImagesWrapper.appendChild(img);
            });
            
            const hasMultiple = data.images.length > 1 && data.images[0] !== "https://placehold.co/400x400/222/white?text=No+Image";
            prevBtn.style.display = hasMultiple ? 'flex' : 'none';
            nextBtn.style.display = hasMultiple ? 'flex' : 'none';

            modalActions.innerHTML = ''; 
            modalActions.style.display = 'flex';
            modalActions.style.flexDirection = 'column';
            modalActions.style.gap = '10px';

            const ownerNumber = "628988685425"; 
            const trustedNumbers = ["628123456789", "628999999999"];

            const textOwner = encodeURIComponent(`Halo Admin, saya ingin membeli produk *${data.name}* seharga ${priceFormatted}. Masih ready?`);
            const textSeller = encodeURIComponent(`Halo kak, saya ingin membeli produk *${data.name}* seharga ${priceFormatted}. Masih tersedia?`);
            const textRekber = encodeURIComponent(`Halo Admin, saya ingin request *JASA REKBER*.\n\nProduk: ${data.name}\nHarga: ${priceFormatted}\nLink Penjual: https://wa.me/${rawWa}\n\nMohon bantuannya min.`);

            if (rawWa === ownerNumber) {
                const btn = createButton("BELI SEKARANG (ADMIN)", "linear-gradient(to right, #00f2ff, #007bff)", "black");
                btn.onclick = () => window.open(`https://wa.me/${ownerNumber}?text=${textOwner}`, '_blank');
                modalActions.appendChild(btn);

            } else if (trustedNumbers.includes(rawWa)) {
                const btn = createButton("BELI SEKARANG (TERPERCAYA)", "linear-gradient(to right, #00c853, #009624)", "white");
                btn.onclick = () => window.open(`https://wa.me/${rawWa}?text=${textSeller}`, '_blank');
                modalActions.appendChild(btn);

            } else {
                const btnDirect = createButton("BELI SEKARANG (DIRECT)", "linear-gradient(to right, #ff9800, #f57c00)", "white");
                btnDirect.onclick = () => window.open(`https://wa.me/${rawWa}?text=${textSeller}`, '_blank');
                
                const btnRekber = createButton("BELI DENGAN AMAN (REKBER)", "linear-gradient(to right, #9c27b0, #673ab7)", "white");
                btnRekber.onclick = () => window.open(`https://wa.me/${ownerNumber}?text=${textRekber}`, '_blank');

                modalActions.appendChild(btnDirect);
                modalActions.appendChild(btnRekber);
            }

            productModal.style.display = 'flex';
        };

        function createButton(text, background, color) {
            const btn = document.createElement('button');
            btn.className = 'btn-modal';
            btn.innerText = text;
            btn.style.background = background;
            btn.style.color = color;
            btn.style.width = "100%"; 
            btn.style.padding = "12px";
            btn.style.border = "none";
            btn.style.borderRadius = "8px";
            btn.style.fontWeight = "bold";
            btn.style.cursor = "pointer";
            btn.style.marginBottom = "5px";
            return btn;
        }

        window.closeModal = function() { productModal.style.display = 'none'; };
        window.moveSlide = function(n) {
            if (currentModalImages.length <= 1) return;
            const images = document.querySelectorAll('.slider-img');
            if (images[currentSlideIndex]) images[currentSlideIndex].classList.remove('active');
            currentSlideIndex += n;
            if (currentSlideIndex >= images.length) currentSlideIndex = 0;
            if (currentSlideIndex < 0) currentSlideIndex = images.length - 1;
            if (images[currentSlideIndex]) images[currentSlideIndex].classList.add('active');
        };
        productModal.addEventListener('click', (e) => { if (e.target === productModal) closeModal(); });

        // --- INFO MODAL ---
        const infoModal = document.getElementById('infoModal');
        const btnSidebarInfo = document.getElementById('btn-sidebar-info');

        if (btnSidebarInfo) {
            btnSidebarInfo.addEventListener('click', (e) => {
                e.preventDefault();
                infoModal.style.display = 'flex';
                closeAllSidebars();
            });
        }
        window.closeInfoModal = function() { infoModal.style.display = 'none'; };
        infoModal.addEventListener('click', (e) => { if (e.target === infoModal) closeInfoModal(); });

        // --- PAGE TRANSITION & LOADING ---
        function showPage(pageId) {
            loadingOverlay.style.display = 'none';
            halamanBaru.style.display = 'block';
            navbar.classList.add('show');
            defaultContent.style.display = 'none';
            allPageContent.forEach(el => el.style.display = 'none');

            const targetElement = document.getElementById(pageId + '-content');
            let pageTitle = "Website Isnpro";
            let newUrl = window.location.pathname;

            if (targetElement) {
                targetElement.style.display = 'block';
                pageTitle = categoryMap[pageId] || "Welcome to website isnpro";
                const h2 = targetElement.querySelector('h2'); if(h2) h2.innerText = pageTitle;
                newUrl = '?page=' + pageId;
                loadProducts(pageId);
            } else {
                defaultContent.style.display = 'block';
                pageId = 'default';
            }
            if (window.location.search !== newUrl) history.pushState({page: pageId}, pageTitle, newUrl);
            document.title = pageTitle;
        }

        function startLoading() {
            loadingOverlay.style.display = 'flex'; animateLoadingText();
            // TIMEOUT DIKURANGI JADI 1500 (1.5 Detik) AGAR CEPAT
            setTimeout(() => {
                loadingOverlay.style.display = 'none'; clearInterval(textInterval);
                showPage('default'); history.pushState({}, "Home", window.location.pathname);
            }, 1500);
        }
        function animateLoadingText() {
            let dots = 0; loadingText.textContent = 'loading'; clearInterval(textInterval);
            textInterval = setInterval(() => { dots = (dots + 1) % 4; loadingText.textContent = 'loading' + '.'.repeat(dots); }, 500);
        }

        // --- DOM CONTENT LOADED (Pengganti window.onload yang lambat) ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page'); 
            createStars(); 
            
            // Jalankan perhitungan counter sidebar di background
            updateSidebarCounts();

            if (page) showPage(page); else startLoading();
        });

        window.onpopstate = () => {
            const params = new URLSearchParams(window.location.search);
            showPage(params.get('page') || 'default');
        };
        function createStars() {
            const container = document.getElementById('star-container');
            for (let i = 0; i < 40; i++) {
                const star = document.createElement('div'); star.classList.add('star');
                star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
                const size = Math.random() * 2 + 1; star.style.width = size + 'px'; star.style.height = size + 'px';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's'; star.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(star);
            }
        }
    </script>
</body>
</html>